title: Setting up blog with Pelican
date: 2016-04-23 7:00AM
tags: python, pelican

I am using [GitHub pages](https://pages.github.com/) to host this blog. The static HTML content is generated from the Markdown text using [Pelican](http://blog.getpelican.com/).  

The typical work flow is:

1. Write content in Markdown
2. Push changes to GitHub 
3. [Travis](https://travis-ci.org/) detects changes and generates the HTML using Pelican

Here I document the steps for my setup. I did my setup on a Mac but these instructions should work for any *nix based system.

### Setup a GitHub repository 

We start with setting up a new GitHub repostiroy. The respostoriy should be named as *username.github.io*, where username is the name that you used to signup for the GitHub accout. That is how GitHub pages will know to serve your content at *http://username.github.io*. You can also point your own domain to this page. 

The GitHub pages serve static HTML content off of *master* branch of your repostiory. However, you would also like to keep the Markdown source files around as well. So, its better to have separate branches  for different type of conent. I would recommend keeping three branches: *master* for the HTML content, *sources* for the raw text, and a *draft* branch for working and refining a post before making it live. You can look at the repo for this blog [here](https://github.com/n-log-n/n-log-n.github.io) to get an idea. The content is in the source branch and is processed by Pelican to generate the HTML that always overwrites the master branch. 

### Setting up Pelican

Pelican is a Python library/tool. You can easily install it using the [pip](https://pip.pypa.io/en/stable/installing/) installer. A better approach is to first setup a [virtualenv](https://virtualenv.pypa.io/en/latest/) and then install this tool. This will ensure the dependencies installed by pelican do not interfere with your other development environment.  


```
pip install virtualenv

# Setup the new virtual environemnt. 

virtualenv ~/virtualenvs/pelican

# To use the new virtual environemnt
source ~/virtualenvs/pelican/bin/activate

# Install Pelican
pip install pelican

```

To setup a new project, you will use the **pelican-quickstart** script. When you run the script, it will ask questions to help you configure your new site. These settings are stored in *pelicanconf.py* file that is the main configuration file for your blog and contains variables to modify things like theme, paths, plugins etc. 


```
$ pelican-quickstart 

Welcome to pelican-quickstart v3.6.3.

This script will help you create a new Pelican-based website.

Please answer the following questions so this script can generate the files
needed by Pelican.

    
> Where do you want to create your new web site? [.] 
> What will be the title of this web site? 
...

```

The directory structure generated by the pelican is fairly straight forward. You write your content under the **content** directory, the generated HTML goes to the **output** directory. The provided **Makefile** allows you to generate the output along with running the embedded server for local testing. When setting up the blog for the first time, you would like to test it locally before pushing it to the server. To get a feel of what comes out of the box with Pelican, run the following commands:

```
# Generate HTML 
make html 

# Run the embedded server
make serve
```

This will launch a server accessible on the [localhost](http://localhost:8080). You should see a default page with out any post. 

### Adding the First Post

We add a post by creating a file under the content directory. A typical post contains a list of variables at the top followed by a space and then the contents of your post. The variables are used by Pelican to configure different aspects of a post.  Depending upon which Pelican theme (next topic) or plug-ins you are using, there might be additional variables available to you. For instance, I have a custom **Tags** variable to tell Pelican under what set of tags to post my blog entry. Pretty Neat! 

Here is a very simple hello world style post. 

```
title: First Post
date: 04-07-2016

Hello Pelican
```

At this point, you should test your post and make sure you can see it on your blog. The post will be linked form the home page. You might need to stop the web server and repeat the make commands above for generating HTML and running the web server. A handy tip to avoid stopping/restarting the server each time you make a change is to run *make devserver* and that will update the HTML as soon as you make a change. 

### Installing Theme

There is large collection of community developed themes available [here](https://github.com/getpelican/pelican-themes). It might take you some time to settle on a theme that you liked. I ended up making a custom one using [bootstrap](http://getbootstrap.com/). You can start with an existing theme and modify it to your needs. Refer to the instructions [here](http://docs.getpelican.com/en/3.6.3/themes.html). I would try to clean-up my theme and post it separately at GitHub soon. 

To install a theme, create a new folder *themes* under the project root directory. Then clone the repository for the desired theme or copy its contents. 


```
mkdir themes

cd themes

git clone https://github.com/demianbrecht/pelican-bold.git
```

Edit the pelicanconf.py and add a new *theme* variable to tell pelican which theme to use when generting the blog. 

```
THEME = themes/pelican-bold
```

At this point, you can re-generate the HTML content to make sure that your theme setup was successfull. 

### Publishing with Travis

To publish your blog you push the contents of your *output* directory to the main branch of your repository. Since we want to keep the raw markdown files around as well. We will be pushing twice for a single post. These steps can be simplified by using a continuous integration tool like [Travis](https://travis-ci.org/). Travis can watch a branch for changes and automatically run a custom script. For our purpose, it will watch the *source* repository and launch pelican to publish HTML content and push it to the *master* branch upon detecting a change. 

To setup Travis, sign-up with your GitHub account on [travis-ci.org](https://travis-ci.org/) and link the current repository. You might want to specify the branch that you want Travis to watch.  Under your project source, create a new file *.travis.yml* and paste in the following content. 

```
language: python
branches:
  only:
  - source
install:
- pip install markdown pelican ghp-import
script:
- make publish github

```

Since it will push to the master branch of your repo, it has to authenticate on Github. For this, we use a OAuth token, that can be created and revoked from the [GitHub access token page](https://github.com/settings/tokens). You can keep this token secret with Travis, by using their command line tools. You can install these tools easily if you already have Ruby's gem tool installed. 

```
gem install travis

travis encrypt GH_TOKEN=<token you got from GitHub>
```

This will add a new block to the end of .travis.yml file.

```
env:
  global:
    secure: NWjh6sCvmjuX.Wo=
```

As Travis simply invokes the Makefile script for publishing the blog, you might need to modify couple of things. 

Modify the value of *GITHUB_PAGES_BRANCH* to point the branch of HTML content - in our case the master branch. Also, towards the end of the script modify the target for github, you might need to specify the fully qualified name of the repostiroy. So modify the git push command to something like this:

```
git push -fq https://${GH_TOKEN}@github.com/$(TRAVIS_REPO_SLUG).git  $(GITHUB_PAGES_BRANCH)
```

 Now, if you push your source branch, travis will happily generate the HTML content and push it to the main branch. 

### Linking a custom Domain

To point a custom domain name to your GitHub blog page, you typically need to do two things : (1) tell GitHub pages which domain is being linked to it, (2) point the nameserver managing your domain to point to the GitHub servers. 

The first step is done by placing a file named *CNAME* on the master branch of your repository with the only content as the fully qualified domain name e.g. www.example.com. As our setup will overwrite the contents of the master branch every time you change your sources. To overcome this, you can configure static paths that are copied as part of the output generation. 

To configure static paths, add the following configuration to *pelicanconf.py* file. The images and extra are directories under you content directory. This will copy the contents of these directories onto the root of the generated content. 

```
STATIC_PATHS = [
	'images',
	'extra/CNAME'
]
```

The second step is to point your domain's name server to your GitHub URL. The steps might vary depending on your domain nameserver. Typically, you will need to add the following two records to your nameserver.

![post](/images/setting-up-pelican-site/dns.png)

Thats mostly it. Enjoy!
